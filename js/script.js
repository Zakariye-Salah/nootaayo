(() => {
  // ---------------- translations placeholder (keep your full translations object here) ----------------
  const translations = {
    en: {
      brand: "Nootaayo Legal",
      "nav.home":"Home",
      "nav.about":"About",
      "nav.lawyers":"Lawyers",
      "nav.services":"Services",
      "nav.partners":"Partners",
      "nav.faq":"FAQ",
      "nav.contact":"Contact",
      book: "Book a Lawyer",
      "hero.title":"Professional Notary, Legal & Property Services",
      "hero.subtitle":"Contracts, property sales, criminal defense, partnerships, land documentation and trusted legal advice.",
      "hero.explore":"Explore Services",
      "hero.book":"Book Consultation",
      "stats.documents":"Documents Certified",
      "stats.clients":"Happy Clients",
      "stats.cases":"Cases Handled",
      "about.title":"About Nootaayo",
      "about.text":"We are licensed notaries and lawyers offering property sales, criminal defense, partnership agreements, contract drafting, land documentation and certified translations. We collect evidence (photos, surveys), prepare contracts, and support secure title transfers.",
      "about.titleWhy":"Why choose us?",
      "about.point1":"Licensed notaries and attorneys â€” trusted by courts and institutions.",
      "about.point2":"Full property services â€” sale, transfer, title checks, photos and registration.",
      "about.point3":"Criminal defense â€” representation and legal protection for accused persons.",
      "about.point4":"Partnership & company formation â€” clear agreements and registration.",
      "about.point5":"Document recording & evidence collection â€” surveys, photos and official filing.",
      "about.more":"We work in Somali & English; remote consultations available.",
      "about.mission":"To make legal services accessible, trustworthy and fast â€” protecting clients' rights in property, criminal and business matters.",
      "about.impact":"We have certified thousands of documents, handled hundreds of property transactions and defended many clients. Our team collectively has decades of experience.",
      "services.title":"Our Services",
      "services.subtitle":"Comprehensive legal support â€” clear, fast and reliable.",
      "partners.title":"Our Partners",
      "partners.subtitle":"Organisations we work with â€” tap or hover to view details.",
      "testimonials.title":"Client Testimonials",
      "testimonials.subtitle":"What clients said about us",
      "filter.all":"All Practices",
      "form.fullname":"Full name",
      "form.email":"Email",
      "form.phone":"Phone",
      "form.message":"Message",
      "form.send":"Send Message",
      "footer.rights":"All rights reserved.",


      //
      brand: "Nootaayo Legal",
      "nav.home":"Home",
      "nav.about":"About",
      "nav.lawyers":"Lawyers",
      "nav.services":"Services",
      "nav.faq":"FAQ",
      "nav.contact":"Contact",
      book: "Book a Lawyer",
      "hero.title":"Professional Notary, Legal & Property Services",
      "hero.subtitle":"Contracts, property sales, criminal defense, partnerships, land documentation and trusted legal advice.",
      "hero.explore":"Explore Services",
      "hero.book":"Book Consultation",
      "stats.documents":"Documents Certified",
      "stats.clients":"Happy Clients",
      "stats.cases":"Cases Handled",
      "about.title":"About Nootaayo",
      "about.text":"We are licensed notaries and lawyers offering property sales, criminal defense, partnership agreements, contract drafting, land documentation and certified translations. We collect evidence (photos, surveys), prepare contracts, and support secure title transfers.",
      "about.titleWhy":"Why choose us?",
      "about.point1":"Licensed notaries and attorneys â€” trusted by courts and institutions.",
      "about.point2":"Full property services â€” sale, transfer, title checks, photos and registration.",
      "about.point3":"Criminal defense â€” representation and legal protection for accused persons.",
      "about.point4":"Partnership & company formation â€” clear agreements and registration.",
      "about.point5":"Document recording & evidence collection â€” surveys, photos and official filing.",
      "about.more":"We work in Somali & English; remote consultations available.",
      "services.title":"Our Services",
      "services.subtitle":"Comprehensive legal support â€” clear, fast and reliable.",
      "services.notary":"Notary & Document Certification",
      "services.notaryText":"Witnessing signatures, certifying documents and preparing official contracts for courts and institutions.",
      "services.propertySale":"Property Sales & Conveyancing",
      "services.propertySaleText":"Assistance with buying/selling houses, title checks, sale agreements and transfers.",
      "services.criminal":"Criminal Defense",
      "services.criminalText":"Defense, police interviews, court representation and appeals.",
      "services.partnership":"Partnerships & Company Formation",
      "services.partnershipText":"Drafting partnership and shareholder agreements, and registering businesses.",
      "services.contracts":"Contract Drafting & Review",
      "services.contractsText":"Drafting clear, enforceable contracts for sale, partnership, employment and services.",
      "services.landDocs":"Land Documentation & Surveying",
      "services.landDocsText":"Collecting evidence, certified photos, land deeds and precise documentation.",
      "services.wills":"Wills & Powers of Attorney",
      "services.willsText":"Drafting wills, probate support, and power of attorney documents.",
      "services.translation":"Legal Translation & Notarized Copies",
      "services.translationText":"Translate and notarize documents between Somali and English for official use.",
      "lawyers.title":"Our Lawyers",
      "filter.all":"All Practices",
      "contact.title":"Contact Us",
      "contact.text":"Questions? Send a message, request a quote, or call for urgent support.",
      "contact.infoTitle":"Office",
      "form.fullname":"Full name",
      "form.email":"Email",
      "form.phone":"Phone",
      "form.date":"Preferred date",
      "form.message":"Message",
      "form.send":"Send Message",
      "form.selectLawyer":"Choose a lawyer",
      "form.lawyer":"Select Lawyer",
      "form.bookNow":"Confirm Booking",
      "modal.title":"Book a Lawyer",
      "footer.rights":"All rights reserved.",
      "testimonials.title":"Client Testimonials",
      "faq.title":"Frequently Asked Questions",
      "faq.q1":"How do I book a consultation?",
      "faq.a1":"Click 'Book a Lawyer' or use the booking form â€” we'll email confirmation and options for in-person or remote meetings.",
      "faq.q2":"Can you handle land title transfers?",
      "faq.a2":"Yes â€” we perform title checks, prepare sale agreements, take required photos and lodge documents with the registry.",
      "faq.q3":"Do you provide legal representation in criminal cases?",
      "faq.a3":"Yes â€” our criminal defense team represents clients at all stages including police interviews and court hearings.",

      "testimonials.title": "Client Testimonials",
      "testimonials.subtitle": "What clients said about us",
      "verifiedText": "Verified",
      "msgSaved": "Message saved locally â€” thank you!",
      "enterMessage": "Please enter a message."      ,

      //faq

      faq: {
        title: "Frequently Asked Questions",
        subtitle: "Common questions about our services, payments and processes.",
      
        q1: "How do I book a lawyer?",
        a1: "You can book a lawyer by contacting us or using the booking form.",
      
        q2: "Do you offer online consultation?",
        a2: "Yes, we provide phone and online consultations.",
      
        q3: "What documents are needed for property transfer?",
        a3: "ID card, ownership documents and sale agreement.",
      
        q4: "How long does notarization take?",
        a4: "Most notarizations are completed the same day.",
      
        q5: "Are your services legally certified?",
        a5: "Yes, all services are provided by licensed professionals.",
      
        q6: "Do you handle criminal cases?",
        a6: "Yes, we represent clients in criminal cases.",
      
        q7: "Do you prepare contracts?",
        a7: "Yes, we prepare all types of legal contracts.",
      
        q8: "What languages do you support?",
        a8: "We support Somali and English.",
      
        q9: "Is my information secure?",
        a9: "Yes, all client information is confidential.",
      
        q10: "Do you notarize translations?",
        a10: "Yes, we provide notarized translations."
      },
      "filter.all": "All Practices",
      "filter.notary": "Notary & Conveyancing",
      "filter.property": "Property Sales",
      "filter.criminal": "Criminal Defense",
      "filter.corporate": "Corporate",
      "form.fullname": "Full name",
      "form.email": "Email",
      "form.message": "Message",
      "form.send": "Send Message",
      "testimonials.leave": "Leave us a message",
      "testimonials.clear": "Clear local messages",
      "testimonials.close": "Close",
      "testimonials.noResults": "No testimonials yet.",
      "lawyers.noResults": "No lawyers match your search."
      
    },
    so: {
      brand: "Nootaayo Sharciga",
      "nav.home":"Hoy",
      "nav.about":"Nagu Saabsan",
      "nav.lawyers":"Qareenno",
      "nav.services":"Adeegyadayad",
      "nav.partners":"La-hawlgalayaasha",
      "nav.faq":"Su'aalaha",
      "nav.contact":"Nala Soo Xiriir",
      book: "Ballan Qareen",
      "hero.title":"Adeegyo Nootaayo, Sharci & Guri oo Xirfad Leh",
      "hero.subtitle":"Qandaraasyo, iibka guryaha, difaac dambiyo, heshiisyada iskaashiga, diiwaangelinta dhulka iyo talo sharci oo la isku halayn karo.",
      "hero.explore":"Baro Adeegyada",
      "hero.book":"Ballan",
      "stats.documents":"Waraaqo la xaqiijiyey",
      "stats.clients":"Macaamiil Faraxsan",
      "stats.cases":"Kiisas la qabtay",
      "about.title":"Nagu Saabsan Nootaayo",
      "about.text":"Waxaan nahay koox qareeno iyo nootaayo ruqsad leh; waxaan ka caawinaa iibka guryaha, difaaca dambiyada, diyaarinta heshiisyada iskaashiga, qandaraasyada, diiwaangelinta dhulka iyo turjumaado la nootaayeyn karo. Waxaan uruurinaa caddeymo (sawirro, saham), diyaarinnaa heshiisyo, kana shaqeynaa wareejinta cinwaanada si amaan ah.",
      "about.titleWhy":"Maxaad noo dooranaysaa?",
      "about.point1":"Nootaayo iyo qareeno ruqsad leh â€” lagu kalsoonaan karo maxkamadaha iyo hay'adaha.",
      "about.point2":"Adeeg buuxa oo guri â€” iib, wareejin, hubinta cinwaanka, sawirro iyo diiwaangelin.",
      "about.point3":"Difaaca dambiyada â€” matalaad iyo ilaalin sharci oo loogu talagalay dadka lagu eedeeyay.",
      "about.point4":"Heshiisyada iskaashiga & diiwaangelinta shirkadaha â€” heshiisyo cad iyo diiwaangelin rasmi ah.",
      "about.point5":"Diiwaangelinta waraaqaha & ururinta caddeynta â€” saham, sawirro iyo kaydin rasmi ah.",
      "about.more":"Waxaan ku shaqeynaa Af-Soomaali & English; ballamo fog iyo kuwa xafiiska labadaba waad heli kartaa.",
      "about.mission":"Himiladeenu waa in adeegyada sharci noqdaan kuwo la heli karo, la isku halayn karo oo degdeg ah â€” ilaalinta xuquuqda macaamiisha.",
      "about.impact":"Waxaan shahaadaynay kumanaan waraaqo, fulinay boqolaal hawl wareejin hanti iyo matalay macaamiil badan. Kooxdayadu waxay leedahay khibrad sanado badan ah.",
      "services.title":"Adeegyadayada",
      "services.subtitle":"Taageero sharci oo dhameystiran â€” cad, degdeg ah oo la isku halayn karo.",
      "partners.title":"La-hawlgalayaashayada",
      "partners.subtitle":"Hay'adaha aan la shaqeyno â€” taabo ama hover si aad u aragto faahfaahin.",
      "testimonials.title":"Qoraallo Macaamiil",
      "testimonials.subtitle":"Waa waxa macaamiishu naga yiraahdeen",
      "filter.all":"Dhamaan",
      "form.fullname":"Magaca oo buuxa",
      "form.email":"Email",
      "form.phone":"Tel",
      "form.message":"Fariin",
      "form.send":"Dir Fariin",
      "footer.rights":"Dhammaan xuquuqda way dhowranyihiin.",

      //
      brand: "Nootaayo Sharciga",
      "nav.home":"Hoy",
      "nav.about":"Nagu Saabsan",
      "nav.lawyers":"Qareenno",
      "nav.services":"Adeegyadeena",
      "nav.faq":"Su'aalaha",
      "nav.contact":"Nala Soo Xiriir",
      book: "Ballan Qareen",
      "hero.title":"Adeegyo Nootaayo, Sharci & Guri oo Xirfad Leh",
      "hero.subtitle":"Qandaraasyo, iibka guryaha, difaac dambiyo, heshiisyada iskaashiga, diiwaangelinta dhulka iyo talo sharci oo la isku halayn karo.",
      "hero.explore":"Baro Adeegyada",
      "hero.book":"Ballan",
      "stats.documents":"Waraaqo la xaqiijiyey",
      "stats.clients":"Macaamiil Faraxsan",
      "stats.cases":"Kiisas la qabtay",
      "about.title":"Nagu Saabsan Nootaayo",
      "about.text":"Waxaan nahay koox qareeno iyo nootaayo ruqsad leh; waxaan ka caawinaa iibka guryaha, difaaca dambiyada, diyaarinta heshiisyada iskaashiga, qandaraasyada, diiwaangelinta dhulka iyo turjumaado la nootaayeyn karo. Waxaan uruurinaa caddeymo (sawirro, saham), diyaarinnaa heshiisyo, kana shaqeynaa wareejinta cinwaanada si amaan ah.",
      "about.titleWhy":"Maxaad noo dooranaysaa?",
      "about.point1":"Nootaayo iyo qareeno ruqsad leh â€” lagu kalsoonaan karo maxkamadaha iyo hay'adaha.",
      "about.point2":"Adeeg buuxa oo guri â€” iib, wareejin, hubinta cinwaanka, sawirro iyo diiwaangelin.",
      "about.point3":"Difaaca dambiyada â€” matalaad iyo ilaalin sharci oo loogu talagalay dadka lagu eedeeyay.",
      "about.point4":"Heshiisyada iskaashiga & diiwaangelinta shirkadaha â€” heshiisyo cad iyo diiwaangelin rasmi ah.",
      "about.point5":"Diiwaangelinta waraaqaha & ururinta caddeynta â€” saham, sawirro iyo kaydin rasmi ah.",
      "about.more":"Waxaan ku shaqeynaa Af-Soomaali & English; ballamo fog iyo kuwa xafiiska labadaba waad heli kartaa.",
      "services.title":"Adeegyadayada",
      "services.subtitle":"Taageero sharci oo dhameystiran â€” cad, degdeg ah oo la isku halayn karo.",
      "services.notary":"Nootaayo & Shahaado Waraaqo",
      "services.notaryText":"Markhaati ka noqoshada saxiixyada, shahaadaysi waraaqaha iyo diyaarinta qandaraasyada rasmiga ah.",
      "services.propertySale":"Iibka Guryaha & Wareejinta",
      "services.propertySaleText":"Caawimaad iibsiga/iibinta guryaha, hubinta cinwaanka, diyaarinta heshiisyada iyo wareejinta.",
      "services.criminal":"Difaaca Dambiyada",
      "services.criminalText":"Difaac, wareysiyada booliska, matalaad maxkamadeed iyo rafcaan.",
      "services.partnership":"Iskaashiyo & Diiwaangelinta Shirkadaha",
      "services.partnershipText":"Diyaarinta heshiisyada iskaashiga iyo diiwaangelinta shirkadaha si loo ilaaliyo saamileyda.",
      "services.contracts":"Diyaarinta & Dib-u-eegista Qandaraasyada",
      "services.contractsText":"Qandaraasyo cad oo la dhaqan gelin karo oo loogu talagalay iibka, iskaashiga, shaqada iyo adeegyada.",
      "services.landDocs":"Diiwaangelinta Dhulka & Sahaminta",
      "services.landDocsText":"Ururinta caddeymaha, sawirro rasmiga ah, waraaqaha dhulka iyo diiwaangelin sax ah.",
      "services.wills":"Testament & Awood-siinta (POA)",
      "services.willsText":"Diyaarinta testament-ka, taageero qaanuuneed iyo dokumentiyo awood-siineed.",
      "services.translation":"Turjumaad Sharci & Nuqullo La Nootaayey",
      "services.translationText":"Turjumaad iyo nootaayeyn waraaqaha u dhexeeya Soomaali iyo Ingiriis si loogu isticmaalo hay'adaha ama dibadda.",
      "lawyers.title":"Qareenadayada",
      "filter.all":"Dhamaan",
      "contact.title":"Nala Soo Xiriir",
      "contact.text":"Su'aalo ma qabtaa? Noo soo dir fariin, codso qiimeyn, ama noo wac haddii ay degdeg tahay.",
      "contact.infoTitle":"Xafiiska",
      "form.fullname":"Magaca oo buuxa",
      "form.email":"Email",
      "form.phone":"Tel",
      "form.date":"Taariikh la doorbido",
      "form.message":"Fariin",
      "form.send":"Dir Fariin",
      "form.selectLawyer":"Xulo qareen",
      "form.lawyer":"Xulo Qareen",
      "form.bookNow":"Xaqiiji Ballanta",
      "modal.title":"Ballan Qareen",
      "footer.rights":"Dhammaan xuquuqda way dhowranyihiin.",
      "testimonials.title":"Qoraallo Macaamiil",
      "faq.title":"Su'aalaha Badanaa La Isweydiiyo",
      "faq.q1":"Sideen u ballan qaataa?",
      "faq.a1":"Riix 'Ballan Qareen' ama isticmaal foomka ballanta â€” waxaan kuu soo diri doonaa xaqiijin iyo ikhtiyaarro kulanka.",
      "faq.q2":"Ma maamuli kartaa wareejinta cinwaanka dhulka?",
      "faq.a2":"Haa â€” waxaan sameynaa hubinta cinwaanka, diyaarinta heshiisyada, sawirro iyo keenista waraaqaha rasmiga ah.",
      "faq.q3":"Ma bixisaa matalaad xagga dambiyada?",
      "faq.a3":"Haa â€” kooxdayada difaaca dambiyada waxay mataleysaa macaamiisha marxaladaha oo dhan.",
      
      "testimonials.title": "Qoraallo Macaamiil",
      "testimonials.subtitle": "Waa waxa macaamiishu naga yiraahdeen",
      "verifiedText": "Xaqiijiyey",
      "msgSaved": "Fariinta waa la keydiyey â€” mahadsanid!",
      "enterMessage": "Fadlan geli fariin.",

      //faq
      faq: {
        title: "Suâ€™aalaha Badanaa La Isweydiiyo",
        subtitle: "Suâ€™aalo la xiriira adeegyadayada iyo habraacyada sharci.",
      
        q1: "Sideen u heli karaa qareen?",
        a1: "Waxaad nagala soo xiriiri kartaa ama isticmaali kartaa foomka ballanta.",
      
        q2: "Ma bixisaan la-talin online ah?",
        a2: "Haa, waxaan bixinaa la-talin taleefan iyo online.",
      
        q3: "Maxaa loo baahan yahay wareejinta guri?",
        a3: "Kaarka aqoonsiga, waraaqaha lahaanshaha iyo heshiiska iibka.",
      
        q4: "Immisa ayay qaadataa nootaayntu?",
        a4: "Badanaa waa isla maalintaas.",
      
        q5: "Adeegyadiinnu sharci ma yihiin?",
        a5: "Haa, dhammaan waa adeegyo sharci ah oo ruqsad leh.",
      
        q6: "Ma qaabilsaan kiisaska dambiyada?",
        a6: "Haa, waan qaabilnaa kiisaska dambiyada.",
      
        q7: "Ma diyaarisaan qandaraasyo?",
        a7: "Haa, waxaan diyaarinaynaa dhammaan qandaraasyada.",
      
        q8: "Luuqado noocee ah ayaad ku shaqeysaan?",
        a8: "Af-Soomaali iyo Af-Ingiriis.",
      
        q9: "Xogtayda ma ammaan baa?",
        a9: "Haa, xogta macaamiisha waa sir.",
      
        q10: "Ma nootaayeysaan turjumaadaha?",
        a10: "Haa, waxaan nootaaynaa turjumaadaha."
      }
      ,
      "filter.all": "Dhamaan",
      "filter.notary": "Nootaayo & Wareejin",
      "filter.property": "Iibka Guryaha",
      "filter.criminal": "Difaaca Dambiyada",
      "filter.corporate": "Shirkad & Ganacsi",
      "form.fullname": "Magaca oo buuxa",
      "form.email": "Email",
      "form.message": "Fariin",
      "form.send": "Dir Fariin",
      "testimonials.leave": "Noo reeb fariin",
      "testimonials.clear": "Nadiifi fariimaha gudaha",
      "testimonials.close": "Xidh",
      "testimonials.noResults": "Wali ma jiraan qoraallo.",
      "lawyers.noResults": "Qareenno ma jiraan oo ku habboon raadinta."
      
    }
  };

  // ---------------- helpers ----------------
  const $ = (s, ctx = document) => ctx.querySelector(s);
  const $$ = (s, ctx = document) => Array.from((ctx || document).querySelectorAll(s));
  const toastContainer = $('#toastContainer');

  // ---------------- state ----------------
  const state = {
    theme: localStorage.getItem('theme') || ((window.matchMedia && window.matchMedia('(prefers-color-scheme:dark)').matches) ? 'dark' : 'light'),
    lang: localStorage.getItem('lang') || 'en',
    lastScrollY: window.scrollY
  };

  // ---------------- i18n apply ----------------
// ---------- replace existing setTextByI18n function with this ----------
    function getNested(obj, path) {
      if (!obj || !path) return undefined;
      return path.split('.').reduce((o, k) => (o && (k in o) ? o[k] : undefined), obj);
    }
  
    function setTextByI18n(lang){
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const val = getNested(translations[lang], key);
        const text = (typeof val !== 'undefined') ? val : (translations[lang] && translations[lang][key]) || el.textContent || key;
        el.textContent = text;
      });
  
      const search = $('#searchLawyer');
      if (search) search.placeholder = getNested(translations[lang], 'filter.all') || '';
  
      // update partner back descriptions if present
      $$('#partnersRow .partner-card').forEach(pc => {
        const back = pc.querySelector('.partner-back .muted');
        if(back){
          const en = pc.dataset['descEn'] || pc.dataset['desc-en'] || pc.dataset.desc || '';
          const so = pc.dataset['descSo'] || pc.dataset['desc-so'] || '';
          back.textContent = (lang === 'so') ? (so || en) : (en || so);
        }
      });
  
      // force testimonials to re-render on language switch
      if (window.__renderTestimonials) window.__renderTestimonials();
    }
  


  // ---------------- toast ----------------
  function showToast(msg, type='success', ttl=3000){
    if(!toastContainer) return;
    const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg;
    toastContainer.appendChild(t);
    requestAnimationFrame(()=> t.classList.add('show'));
    setTimeout(()=> { t.classList.remove('show'); setTimeout(()=> t.remove(), 300); }, ttl);
  }

  // ---------------- theme ----------------
  function applyTheme(t){ if(t === 'dark') document.documentElement.setAttribute('data-theme','dark'); else document.documentElement.removeAttribute('data-theme'); localStorage.setItem('theme', t); }




  // ---------------- header show/hide on scroll (light version) ----------------
  function setupHeaderBehavior(){
    const header = $('#siteHeader'); if(!header) return;
    let hideTimeout = null;
    function setVisible(v){ header.setAttribute('data-visible', v ? 'true' : 'false'); }
    function scheduleHide(){ if(hideTimeout) clearTimeout(hideTimeout); hideTimeout = setTimeout(()=> setVisible(false), 5000); }
    window.addEventListener('scroll', () => {
      const y = window.scrollY;
      if(Math.abs(y - state.lastScrollY) < 10) return;
      if(y > state.lastScrollY) setVisible(false);
      else { setVisible(true); scheduleHide(); }
      state.lastScrollY = y;
    }, {passive:true});
    window.addEventListener('mousemove', (e) => { if(e.clientY < 80){ setVisible(true); scheduleHide(); } });
    if(window.scrollY > 60) scheduleHide();
  }

  // ---------------- back to top ----------------
  function setupBackToTop(){ const btn = $('#backToTop'); if(!btn) return; btn.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'})); }

  // ---------------- image lightbox (with X and Esc) ----------------
  function openImageLightbox(src, title=''){
    if(document.querySelector('.modal.lightbox')) return; // avoid duplicates
    const modal = document.createElement('div'); modal.className = 'modal lightbox'; modal.setAttribute('aria-hidden','false');
    const panel = document.createElement('div'); panel.className = 'lightbox-panel';
    const img = document.createElement('img'); img.src = src; img.alt = title || '';
    const closeBtn = document.createElement('button'); closeBtn.className = 'lightbox-close'; closeBtn.setAttribute('aria-label','Close image'); closeBtn.innerHTML = 'Ã—';
    panel.appendChild(img); panel.appendChild(closeBtn); modal.appendChild(panel);

    function destroy(){
      try{ document.body.removeChild(modal); }catch(e){}
      document.body.style.overflow = '';
      window.removeEventListener('keydown', onKey);
    }
    function onKey(e){ if(e.key === 'Escape') destroy(); }
    closeBtn.addEventListener('click', (ev)=> { ev.stopPropagation(); destroy(); });
    modal.addEventListener('click', (ev)=> { if(ev.target === modal) destroy(); });
    window.addEventListener('keydown', onKey);
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
  }

// Legacy/simple testimonial renderer (safe guard).
(function(){
  const legacyGrid = document.getElementById("testimonialGrid");
  if(!legacyGrid) {
    // New testRow implementation is present â€” skip legacy renderer to avoid conflicts.
    return;
  }

  // If you still have the old markup (#testimonialGrid), keep a small legacy renderer:
  const testimonials = [
    { name: "Ahmed", img: "assets/image1.png", text: "Very professional service." },
    { name: "Amina", img: "assets/image2.png", text: "Excellent legal support." },
    { name: "Mohamed", img: "assets/image3.png", text: "Fast and reliable." },
    { name: "Hodan", img: "assets/image4.png", text: "Very clear guidance." },
    { name: "Ibrahim", img: "assets/image5.png", text: "Highly recommended." }
  ];

  function renderTestimonialsLegacy() {
    legacyGrid.innerHTML = "";
    testimonials.forEach(t => {
      legacyGrid.innerHTML += `
        <div class="test-card">
          <img src="${t.img}" alt="${t.name}">
          <div class="content">
            <strong>${t.name}</strong>
            <p>${t.text}</p>
          </div>
        </div>
      `;
    });
  }

  renderTestimonialsLegacy();

  // Wire the old form (only if it exists)
  const openBtnOld = document.getElementById("openMessageBtn");
  const oldForm = document.getElementById("messageForm"); // legacy id
  if(openBtnOld && oldForm) {
    openBtnOld.addEventListener('click', () => oldForm.classList.toggle('hidden'));
  }
  if(oldForm) {
    oldForm.addEventListener('submit', (e) => {
      e.preventDefault();
      // try to find inputs safely
      const nameInput = oldForm.querySelector('#nameInput') || oldForm.querySelector('input') || { value: 'Anonymous' };
      const messageInput = oldForm.querySelector('#messageInput') || oldForm.querySelector('textarea') || { value: '' };
      const name = (nameInput.value || 'Anonymous').trim();
      const msg = (messageInput.value || '').trim();
      if(!msg) return alert('Please enter a message.');
      testimonials.push({ name, img:'assets/image1.png', text: msg });
      renderTestimonialsLegacy();
      oldForm.reset();
    });
  }
})();

  

/* ---------- Testimonials: rendering, local storage + i18n ---------- */
(function () {
  const STORAGE_KEY = 'nootaayo_messages_v1';
  const row = document.getElementById('testRow');
  const openBtn = document.getElementById('openMessageBtn');
  const closeBtn = document.getElementById('closeMessageForm');
  const form = document.getElementById('clientMessageForm');
  const clearBtn = document.getElementById('clearMessages');

  // static sample testimonials (each entry has en & so)
  const STATIC_TESTIMONIALS = [
    { id: 's-1', name: "Ahmed Hassan", img: "assets/image8.png", en: "Very professional service.", so: "Adeeg aad u xirfad leh.", verified: true, timestamp: Date.now() - 86400000 },
    { id: 's-2', name: "Amina Yusuf",   img: "assets/image9.png", en: "They helped me transfer my land safely.", so: "Waxay iga caawiyeen wareejinta dhulka si ammaan ah.", verified: true, timestamp: Date.now() - 86400000*2 },
    { id: 's-3', name: "Mohamed Ali",   img: "assets/image3.png", en: "Fast and reliable.", so: "Degdeg iyo lagu kalsoonaan karo.", verified: true, timestamp: Date.now() - 86400000*3 },
    { id: 's-4', name: "Hodan Warsame", img: "assets/image4.png", en: "Very clear guidance.", so: "Tilmaan aad u cad.", verified: true, timestamp: Date.now() - 86400000*4 },
    { id: 's-5', name: "Ibrahim Salah", img: "assets/image7.png", en: "Highly recommended.", so: "Si weyn loogu talinayaa.", verified: false, timestamp: Date.now() - 86400000*5 }
  ];

  function loadMessages() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
  }
  function saveMessages(arr) {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); } catch (e) {}
  }

  function initials(name) {
    if(!name) return 'U';
    return name.split(' ').slice(0,2).map(s => s[0]?.toUpperCase()||'').join('');
  }
  function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function formatDate(ts){
    try { return new Date(ts).toLocaleDateString(); } catch(e){ return ''; }
  }

  function createCard(item){
    const card = document.createElement('article');
    card.className = 'test-card';
    card.dataset.id = item.id || ('u' + Date.now());
    card.dataset.verified = item.verified ? '1' : '0';
    const isVerified = !!item.verified;
    const lang = (window.state && window.state.lang) ? window.state.lang : 'en';
    // choose message text based on language (support both en/so fields)
    const message = (lang === 'so') ? (item.so || item.en || '') : (item.en || item.so || '');
    const avatarHtml = item.img ? `<img src="${item.img}" alt="${escapeHtml(item.name)}" />` : `<div class="avatar-initials">${initials(item.name)}</div>`;
  
    card.innerHTML = `
      <div class="avatar" aria-hidden="true">${avatarHtml}</div>
      <div class="content">
        <div class="author">
          <span class="name">${escapeHtml(item.name || 'Anonymous')}</span>
          <span class="meta-right">
            ${ isVerified ? `<img src="assets/verify.png" class="verified-icon" alt="verified" />` : `` }
            <span class="date">${formatDate(item.timestamp || Date.now())}</span>
          </span>
        </div>
  
        <p class="msg">${escapeHtml(message)}</p>
      </div>
      ${ (item.id && String(item.id).startsWith('u')) ? '<button class="verify-toggle" title="Toggle verified">ðŸ”’</button>' : '' }
    `;
    return card;
  }
  
  

  function renderAll(){
    if(!row) return;
    row.innerHTML = '';
    // static testimonials first
    STATIC_TESTIMONIALS.forEach(s => row.appendChild(createCard(s)));
    // user messages (persisted) - show most recent first
    const messages = loadMessages();
    messages.slice().reverse().forEach(m => row.appendChild(createCard(m)));
    // wire verify toggle (delegation)
    wireVerifyToggle();
    updateCarouselButtons();
  }

  // form wiring
  function wireForm(){
    const nameEl = document.getElementById('msgName');
    const emailEl = document.getElementById('msgEmail');
    const textEl = document.getElementById('msgText');

    if(openBtn) openBtn.addEventListener('click', () => {
      form.classList.remove('hidden'); form.setAttribute('aria-hidden','false');
      nameEl?.focus();
    });
    if(closeBtn) closeBtn.addEventListener('click', () => {
      form.classList.add('hidden'); form.setAttribute('aria-hidden','true');
    });

    if(form){
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = (nameEl && nameEl.value.trim()) || 'Anonymous';
        const email = (emailEl && emailEl.value.trim()) || '';
        const text = (textEl && textEl.value.trim()) || '';
        if(!text) { alert((state.lang === 'so') ? (translations.so.enterMessage || 'Fadlan geli fariin.') : (translations.en.enterMessage || 'Please enter a message.')); return; }
        const messages = loadMessages();
        // store both en & so fields (we keep same text for both - you can later translate server-side)
        const item = { id: 'u' + Date.now(), name, email, en: text, so: text, verified: false, timestamp: Date.now() };
        messages.push(item);
        saveMessages(messages);
        form.reset();
        form.classList.add('hidden'); form.setAttribute('aria-hidden','true');
        renderAll();
        showToast((state.lang === 'so') ? (translations.so.msgSaved || 'Fariinta waa la keydiyey') : (translations.en.msgSaved || 'Message saved locally â€” thank you!'), 'success', 2000);
      });
    }

    if(clearBtn) clearBtn.addEventListener('click', () => {
      if(!confirm((state.lang === 'so') ? 'Ma rabtaa in la nadiifiyo fariimaha gudaha?' : 'Clear locally stored messages?')) return;
      localStorage.removeItem(STORAGE_KEY);
      renderAll();
      showToast((state.lang === 'so') ? 'Fariimaha gudaha waa la nadiifiyey' : 'Local messages cleared', 'success', 1600);
    });
  }

  // verify toggle delegation
  function wireVerifyToggle(){
    if(!row) return;
    row.removeEventListener('click', handleRowClick);
    row.addEventListener('click', handleRowClick);
  }
  function handleRowClick(e){
    const btn = e.target.closest('.verify-toggle');
    if(!btn) return;
    e.stopPropagation();
    const card = btn.closest('.test-card');
    if(!card) return;
    const id = card.dataset.id;
    if(id && String(id).startsWith('u')) {
      const messages = loadMessages();
      const idx = messages.findIndex(m => m.id === id);
      if(idx !== -1) {
        messages[idx].verified = !messages[idx].verified;
        saveMessages(messages);
        renderAll();
      }
    } else {
      const vb = card.querySelector('.verified-badge');
      if(vb) vb.classList.toggle('hidden');
    }
  }

  // carousel buttons
  const prevBtn = document.getElementById('testPrev');
  const nextBtn = document.getElementById('testNext');
  function updateCarouselButtons(){
    if(!row) return;
    const max = row.scrollWidth - row.clientWidth;
    if(prevBtn) prevBtn.classList.toggle('hidden', row.scrollLeft <= 6);
    if(nextBtn) nextBtn.classList.toggle('hidden', row.scrollLeft >= max - 6 || max <= 6);
  }
  function wireCarousel(){
    if(!row) return;
    prevBtn?.addEventListener('click', () => { row.scrollBy({ left: -Math.round(row.clientWidth * 0.9), behavior: 'smooth' }); setTimeout(updateCarouselButtons, 300); });
    nextBtn?.addEventListener('click', () => { row.scrollBy({ left:  Math.round(row.clientWidth * 0.9), behavior: 'smooth' }); setTimeout(updateCarouselButtons, 300); });
    row.addEventListener('scroll', updateCarouselButtons);
    window.addEventListener('resize', () => setTimeout(updateCarouselButtons, 120));
    // pointer drag protection
    let isDown=false, startX=0, scrollLeft=0;
    row.addEventListener('pointerdown', e=>{ isDown=true; try{ row.setPointerCapture(e.pointerId);}catch(_){} startX=e.clientX; scrollLeft=row.scrollLeft; });
    row.addEventListener('pointermove', e=>{ if(!isDown) return; const dx = startX - e.clientX; row.scrollLeft = scrollLeft + dx; updateCarouselButtons(); });
    row.addEventListener('pointerup', e=>{ isDown=false; try{ row.releasePointerCapture(e.pointerId);}catch(_){}; updateCarouselButtons(); });
    row.addEventListener('pointercancel', ()=> isDown=false);
  }

  // expose render function so i18n can re-render
  window.__renderTestimonials = renderAll;

  // init local things
  document.addEventListener('DOMContentLoaded', () => {
    renderAll();
    wireForm();
    wireCarousel();
  });
})();




  // ---------------- partners carousel & flip (desktop hover, mobile click) ----------------
  function setupPartnersCarousel(){
    const row = document.getElementById('partnersRow');
    const prev = document.getElementById('partnersPrev');
    const next = document.getElementById('partnersNext');
    if(!row) return;
  
    // mark touch devices so CSS hover-flips can be disabled
    try {
      const isTouch = (window.matchMedia && window.matchMedia('(hover: none)').matches) || ('ontouchstart' in window);
      if(isTouch) document.documentElement.classList.add('is-touch');
    } catch(e){}
  
    function updateButtons(){
      const maxScrollLeft = row.scrollWidth - row.clientWidth;
      const atStart = row.scrollLeft <= 6;
      const atEnd = row.scrollLeft >= Math.max(0, maxScrollLeft - 6);
      // hide both if no overflow
      const noOverflow = maxScrollLeft <= 2;
      if(prev) prev.classList.toggle('hidden', noOverflow || atStart);
      if(next) next.classList.toggle('hidden', noOverflow || atEnd);
    }
  
    // button clicks (scroll by viewport fraction)
    prev?.addEventListener('click', ()=> { row.scrollBy({ left: -Math.round(row.clientWidth * 0.8), behavior: 'smooth' }); setTimeout(updateButtons, 360); });
    next?.addEventListener('click', ()=> { row.scrollBy({ left:  Math.round(row.clientWidth * 0.8), behavior: 'smooth' }); setTimeout(updateButtons, 360); });
  
    // pointer drag (touch & mouse) â€” you already had this; keep it
    let isDown=false, startX=0, scrollLeft=0;
    row.addEventListener('pointerdown', e => { isDown=true; try{ row.setPointerCapture(e.pointerId);}catch(_){ } startX=e.clientX; scrollLeft=row.scrollLeft; });
    row.addEventListener('pointermove', e => { if(!isDown) return; const dx = startX - e.clientX; row.scrollLeft = scrollLeft + dx; updateButtons(); });
    row.addEventListener('pointerup', e => { isDown=false; try{ row.releasePointerCapture(e.pointerId);}catch(_){}; updateButtons(); });
    row.addEventListener('pointercancel', ()=> isDown=false);
  
    // mouse wheel -> horizontal scroll (desktop). Prevent vertical scroll while hovering the row.
    row.addEventListener('wheel', (e) => {
      // if user holds shift they probably want horizontal default â€” don't override shift behavior
      if(e.shiftKey) return;
      // if significant vertical delta, scroll horizontally
      if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){
        e.preventDefault();
        row.scrollLeft += e.deltaY;
      }
      // small delay to recompute buttons (let scroll settle)
      setTimeout(updateButtons, 50);
    }, { passive: false });
  
    // ensure the row itself is focusable for keyboard nav
    if(!row.hasAttribute('tabindex')) row.setAttribute('tabindex','0');
    row.addEventListener('keydown', (e) => {
      if(e.key === 'ArrowRight'){ e.preventDefault(); next?.click(); }
      if(e.key === 'ArrowLeft'){ e.preventDefault(); prev?.click(); }
      if(e.key === 'Home'){ e.preventDefault(); row.scrollTo({left:0, behavior:'smooth'}); }
      if(e.key === 'End'){ e.preventDefault(); row.scrollTo({left: row.scrollWidth, behavior:'smooth'}); }
    });
  
    // normalize structure for each partner-card (keeps what you already did)
    const cards = Array.from(row.querySelectorAll('.partner-card'));
    cards.forEach(pc => {
      const name = pc.dataset.name || (pc.querySelector('strong')?.textContent?.trim()) || '';
      const srcImg = pc.querySelector('img')?.src || pc.dataset.img || '';
      const alt = pc.querySelector('img')?.alt || name || '';
      const descEn = pc.dataset['desc-en'] || pc.dataset['descEn'] || pc.dataset.desc || '';
      const descSo = pc.dataset['desc-so'] || pc.dataset['descSo'] || '';
  
      pc.innerHTML = `
        <div class="partner-inner" role="group" aria-label="${name}">
          <div class="partner-front" aria-hidden="false">
            <img src="${srcImg}" alt="${alt}" />
          </div>
          <div class="partner-back" aria-hidden="true">
            <h4>${name}</h4>
            <p class="muted">${(state && state.lang === 'so') ? (descSo || descEn) : (descEn || descSo)}</p>
          </div>
        </div>
      `;
      pc.classList.remove('is-flipped');
      pc.setAttribute('tabindex','0');
    });
  
    // wire events after normalization (image lightbox / flip / keyboard)
    row.querySelectorAll('.partner-card').forEach(pc => {
      const img = pc.querySelector('.partner-front img');
  
      function closeOtherFlips(){ row.querySelectorAll('.partner-card.is-flipped').forEach(c => { if(c !== pc) c.classList.remove('is-flipped'); }); }
  
      if(img){
        img.style.cursor = 'zoom-in';
        img.addEventListener('click', ev => { ev.stopPropagation(); openImageLightbox(img.src, pc.dataset.name || img.alt || ''); });
        img.setAttribute('tabindex','0');
        img.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openImageLightbox(img.src, pc.dataset.name || img.alt || ''); } });
      }
  
      pc.addEventListener('click', (e) => {
        if(e.target.closest('.partner-front img')) return;
        const toggled = pc.classList.toggle('is-flipped');
        if(toggled) closeOtherFlips();
      });
  
      pc.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); const toggled = pc.classList.toggle('is-flipped'); if(toggled) closeOtherFlips(); }
        else if(e.key === 'Escape') pc.classList.remove('is-flipped');
      });
  
      // keep aria-hidden in sync
      const observer = new MutationObserver(() => {
        const back = pc.querySelector('.partner-back');
        const front = pc.querySelector('.partner-front');
        if(pc.classList.contains('is-flipped')){
          back && back.setAttribute('aria-hidden','false');
          front && front.setAttribute('aria-hidden','true');
        } else {
          back && back.setAttribute('aria-hidden','true');
          front && front.setAttribute('aria-hidden','false');
        }
      });
      observer.observe(pc, { attributes: true, attributeFilter: ['class'] });
    });
  
    // update on scroll / resize
    row.addEventListener('scroll', () => { requestAnimationFrame(updateButtons); });
    window.addEventListener('resize', () => { setTimeout(updateButtons, 120); });
  
    // initial check
    setTimeout(updateButtons, 50);
  }
  
  

  // ---------------- collect lawyers into booking select ----------------
  function collectLawyers(){
    const cards = $$('#lawyerList .card');
    const sel = $('#bookLawyer');
    if(!sel) return;
    sel.innerHTML = `<option value="" disabled selected>${(translations[state.lang] && translations[state.lang]['form.selectLawyer']) ? translations[state.lang]['form.selectLawyer'] : 'Choose a lawyer'}</option>`;
    cards.forEach(c => {
      const name = c.dataset.name || c.querySelector('.card-title')?.textContent?.trim() || 'Unknown';
      const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
      sel.appendChild(opt);
    });
  }

  // ---------------- booking form ----------------
  function setupBookingForm(){
    const form = $('#bookingForm'); if(!form) return;
    form.addEventListener('submit', e => {
      e.preventDefault();
      const data = {
        fullname: $('#bookFullname').value.trim(),
        email: $('#bookEmail').value.trim(),
        phone: $('#bookPhone').value.trim(),
        lawyer: $('#bookLawyer').value,
        date: $('#bookDate').value,
        message: $('#bookMessage').value.trim()
      };
      if(!data.fullname || !data.email || !data.phone || !data.lawyer || !data.date){
        showToast(state.lang === 'so' ? 'Fadlan buuxi dhammaan meelaha looga baahan yahay' : 'Please fill required fields', 'error');
        return;
      }
      console.log('Booking:', data);
      closeModal('bookingModal');
      showToast(state.lang === 'so' ? 'Ballantaada waa la diiwaan geliyey' : 'Your booking has been recorded', 'success');
    });
  }

  // ---------------- contact & subscribe ----------------
  function setupContactForm(){
    const f = $('#contactForm'); if(!f) return;
    f.addEventListener('submit', e => {
      e.preventDefault();
      const fn = $('#contactFullname').value.trim(), em = $('#contactEmail').value.trim(), msg = $('#contactMessage').value.trim();
      if(!fn || !em || !msg){ showToast(state.lang === 'so' ? 'Fadlan buuxi dhammaan meelaha looga baahan yahay' : 'Please fill required fields', 'error'); return; }
      console.log('Contact:', {fn,em,msg});
      $('#contactForm').reset();
      showToast(state.lang === 'so' ? `${fn}, waa lagu mahadsan tahay. Waxaan helnay fariintaada.` : `Thanks ${fn}, we received your message.`, 'success');
    });
  }
  function setupSubscribe(){ const s = $('#subscribeForm'); if(!s) return; s.addEventListener('submit', e => { e.preventDefault(); const email = $('#subscribeEmail').value.trim(); if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ showToast(state.lang === 'so' ? 'Fadlan geli email sax ah' : 'Please enter a valid email','error'); return; } $('#subscribeForm').reset(); showToast(state.lang === 'so' ? 'Waad ku mahadsan tahay, email-kaaga waanu helnay' : 'Thanks â€” your subscription is confirmed', 'success'); }); }

  // ---------------- profile rendering & wiring ----------------
  const lawyerProfiles = {
    "Amina Yusuf": { img: "assets/image8.png", title: "Notary & Property Law", bio: "Ahmed has 8+ years in property law: sale agreements, title checks, transfer and notarization. She ensures clear paperwork and safe land registrations.", specialties: ["Property Conveyancing","Notary Certification","Title Verification"], languages: "Somali, English", experience: "8 years", contact: "+252 61 111 1111" },
    "Mohamed Ali": { img: "assets/image9.png", title: "Criminal Defense", bio: "Mohamed represents clients at police and court proceedings, focusing on rights protection, bail and appeals.", specialties: ["Criminal Defense","Bail & Appeals","Police Representation"], languages: "Somali, English", experience: "10 years", contact: "+252 61 222 2222" },
    "Hodan Warsame": { img: "assets/image2.png", title: "Corporate & Commercial", bio: "Hodan advises companies on governance, contracts and compliance.", specialties: ["Corporate Law","Contracts","Company Formation"], languages: "Somali, English", experience: "7 years", contact: "+252 61 333 3333" },
    "Abdirahman Noor": { img: "assets/image3.png", title: "Property & Conveyancing", bio: "Abdirahman specializes in land surveys, documentation and secure transfers.", specialties: ["Land Documentation","Surveys","Sale Agreements"], languages: "Somali, English", experience: "6 years", contact: "+252 61 444 4444" },
    "Sahra Mohamed": { img: "assets/image2.png", title: "Notary & Wills", bio: "Sahra focuses on wills, probate and notarized legal translations.", specialties: ["Wills & Probate","Notarized Translations","Family Law"], languages: "Somali, English", experience: "9 years", contact: "+252 61 555 5555" },
    "Ibrahim Salah": { img: "assets/image7.png", title: "Contracts & Transactions", bio: "Ibrahim drafts contracts that prevent disputes and protect businesses.", specialties: ["Contract Drafting","Commercial Transactions","Dispute Prevention"], languages: "Somali, English", experience: "8 years", contact: "+252 61 666 6666" }
  };

  function renderProfile(name){
    const data = lawyerProfiles[name];
    const container = $('#profileContent');
    if(!container) return;
    if(!data){
      container.innerHTML = `<p>Profile not found: ${name}</p>`;
      return;
    }
    container.innerHTML = `
      <div>
        <img src="${data.img}" class="profile-top" alt="${name}" />
        <div class="profile-main">
          <h3 id="profileTitle">${name}</h3>
          <div class="muted">${data.title}</div>
          <p class="muted" style="margin-top:10px">${data.bio}</p>
          <p><strong>Specialties:</strong> ${data.specialties.join(', ')}</p>
          <p><strong>Experience:</strong> ${data.experience}</p>
          <p><strong>Languages:</strong> ${data.languages}</p>
          <p><strong>Contact:</strong> ${data.contact}</p>
          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn-primary" id="profileBookBtn">Book ${name}</button>
            <button class="btn-outline" id="profileCloseBtn">Close</button>
          </div>
        </div>
      </div>
    `;
    $('#profileBookBtn')?.addEventListener('click', ()=> { closeModal('profileModal'); openModal('bookingModal'); setTimeout(()=> { $('#bookLawyer').value = name; }, 60); });
    $('#profileCloseBtn')?.addEventListener('click', ()=> closeModal('profileModal'));
  }

/* ---------- Profile & service wiring (replace existing function) ---------- */
function setupProfileAndCards(){
  // Make only the lawyer image and view-profile button open profile. Card itself is NOT clickable.
  $$('#lawyerList .card').forEach(card => {
    const img = card.querySelector('.card-img');
    const name = card.dataset.name || card.querySelector('.card-title')?.textContent?.trim();
    // remove any click handlers on card itself if present (safe-guard)
    card.onclick = null;
    // image click opens profile
    if(img){
      img.style.cursor = 'zoom-in';
      img.addEventListener('click', (e) => {
        e.stopPropagation();
        if(name){ renderProfile(name); openModal('profileModal'); }
      });
    }
    // keyboard for image
    if(img){
      img.setAttribute('tabindex','0');
      img.addEventListener('keydown', (e) => { if(e.key === 'Enter'){ if(name){ renderProfile(name); openModal('profileModal'); } } });
    }
  });

  // view-profile buttons (stop propagation so no other handlers interfere)
  $$('.view-profile').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const name = btn.dataset.lawyer;
      if(name){ renderProfile(name); openModal('profileModal'); }
    });
  });

  // book-now buttons (unchanged)
  $$('.book-now').forEach(b => b.addEventListener('click', (e)=> {
    e.stopPropagation();
    openModal('bookingModal');
    setTimeout(() => {
      const sel = $('#bookLawyer');
      if (sel && e.currentTarget.dataset.lawyer) sel.value = e.currentTarget.dataset.lawyer;
    }, 80);
  }));

  // service thumbnails open lightbox (unchanged)
  $$('.service-thumb').forEach(img => { img.style.cursor='zoom-in'; img.addEventListener('click', ev => { ev.stopPropagation(); openImageLightbox(img.src, img.alt || 'Service'); }); });

  // reveal animation class
  $$('.card-anim').forEach(el => el.classList.add('revealed'));

  // --- BOTTOM modal buttons wiring (Confirm + Close) for booking modal ---
  const confirmBottom = document.getElementById('bookingConfirmBottom');
  const closeBottom = document.getElementById('bookingCloseBottom');
  if(confirmBottom){
    confirmBottom.addEventListener('click', (ev) => {
      ev.preventDefault();
      // trigger the booking form submit programmatically
      const form = document.getElementById('bookingForm');
      if(form) form.requestSubmit ? form.requestSubmit() : form.dispatchEvent(new Event('submit', {cancelable:true}));
    });
  }
  if(closeBottom){
    closeBottom.addEventListener('click', (ev) => {
      ev.preventDefault();
      closeModal('bookingModal');
    });
  }
}


  // ---------------- modal helpers ----------------
  function openModal(id){ const modal = document.getElementById(id); if(!modal) return; modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
  function closeModal(id){ const modal = document.getElementById(id); if(!modal) return; modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; const f = modal.querySelector('form'); if(f) f.reset(); }

  // ---------------- reveal & counters (simple) ----------------
  function setupRevealAndCounters(){
    const obs = new IntersectionObserver(entries => { entries.forEach(e => { if(e.isIntersecting){ e.target.classList.add('revealed'); obs.unobserve(e.target); } }); }, {threshold:0.12});
    $$('.reveal').forEach(el => obs.observe(el));
    $$('.stat-num').forEach(el => {
      const target = +el.dataset.target || 0; let cur = 0; const step = Math.max(1, Math.floor(target/60));
      function tick(){ cur += step; if(cur >= target) el.textContent = target; else { el.textContent = cur; requestAnimationFrame(tick); } }
      const obs2 = new IntersectionObserver(entries => { if(entries[0].isIntersecting){ tick(); obs2.disconnect(); } }, {threshold:0.5});
      obs2.observe(el);
    });
  }

  // ---------------- testimonials (light wiring) ----------------
  function setupTestimonials(){
    const row = $('#testRow'); if(!row) return;
    const prev = $('#testPrev'), next = $('#testNext');
    function updateButtons(){ const maxScrollLeft = row.scrollWidth - row.clientWidth; prev?.classList.toggle('hidden', row.scrollLeft <= 6); next?.classList.toggle('hidden', row.scrollLeft >= maxScrollLeft - 6); }
    prev?.addEventListener('click', ()=> { row.scrollBy({left:-row.clientWidth * 0.92, behavior:'smooth'}); setTimeout(updateButtons,300); });
    next?.addEventListener('click', ()=> { row.scrollBy({left:row.clientWidth * 0.92, behavior:'smooth'}); setTimeout(updateButtons,300); });
    let isDown=false, startX=0, scrollLeft=0;
    row.addEventListener('pointerdown', e=>{ isDown=true; row.setPointerCapture(e.pointerId); startX=e.clientX; scrollLeft=row.scrollLeft; });
    row.addEventListener('pointermove', e=>{ if(!isDown) return; const dx = startX - e.clientX; row.scrollLeft = scrollLeft + dx; updateButtons(); });
    row.addEventListener('pointerup', e=>{ isDown=false; try{ row.releasePointerCapture(e.pointerId);} catch(_){}; updateButtons(); });
    row.addEventListener('pointercancel', ()=> isDown=false);
    $$('#testRow .testimonial').forEach(tb => { tb.querySelector('p').textContent = tb.dataset[state.lang === 'so' ? 'so' : 'en']; });
    row.addEventListener('scroll', updateButtons); window.addEventListener('resize', updateButtons); updateButtons();
  }// ---------- Search & Filter for Lawyers + i18n placeholders ----------

// Example translations additions â€” add these keys to your full translations object (merge)
const translationsPatch = {
  en: {
    "filter.all": "All Practices",
    "filter.notary": "Notary & Conveyancing",
    "filter.property": "Property Sales",
    "filter.criminal": "Criminal Defense",
    "filter.corporate": "Corporate",
    "form.fullname": "Full name",
    "form.email": "Email",
    "form.message": "Message",
    "form.send": "Send Message",
    "testimonials.leave": "Leave us a message",
    "testimonials.clear": "Clear local messages",
    "testimonials.close": "Close",
    "testimonials.noResults": "No testimonials yet.",
    "lawyers.noResults": "No lawyers match your search."
  },
  so: {
    "filter.all": "Dhamaan",
    "filter.notary": "Nootaayo & Wareejin",
    "filter.property": "Iibka Guryaha",
    "filter.criminal": "Difaaca Dambiyada",
    "filter.corporate": "Shirkad & Ganacsi",
    "form.fullname": "Magaca oo buuxa",
    "form.email": "Email",
    "form.message": "Fariin",
    "form.send": "Dir Fariin",
    "testimonials.leave": "Noo reeb fariin",
    "testimonials.clear": "Nadiifi fariimaha gudaha",
    "testimonials.close": "Xidh",
    "testimonials.noResults": "Wali ma jiraan qoraallo.",
    "lawyers.noResults": "Qareenno ma jiraan oo ku habboon raadinta."
  }
};

// Merge patch into your translations object if present
if (typeof translations === 'object') {
  Object.keys(translationsPatch).forEach(lang => {
    translations[lang] = Object.assign({}, translations[lang] || {}, translationsPatch[lang]);
  });
}

// Helper: update niceties for search/filter + placeholders
function updateSearchAndFormText(lang) {
  // search input placeholder
  const search = document.getElementById('searchLawyer');
  if (search) {
    search.placeholder = (translations[lang] && translations[lang]['filter.all']) ? translations[lang]['filter.all'] + '...' : 'Search';
  }

  // practice filter options - translate text content for each option with data-i18n
  const pf = document.getElementById('practiceFilter');
  if (pf) {
    Array.from(pf.options).forEach(opt => {
      const key = opt.getAttribute('data-i18n');
      if (key && translations[lang] && translations[lang][key]) opt.textContent = translations[lang][key];
    });
  }

  // message form placeholders
  const name = document.getElementById('msgName');
  const email = document.getElementById('msgEmail');
  const textarea = document.getElementById('msgText');
  const openBtn = document.getElementById('openMessageBtn');
  const sendBtn = document.querySelector('#clientMessageForm button[type="submit"]');

  if (name) name.placeholder = translations[lang] && translations[lang]['form.fullname'] ? translations[lang]['form.fullname'] : 'Full name';
  if (email) email.placeholder = translations[lang] && translations[lang]['form.email'] ? translations[lang]['form.email'] : 'Email';
  if (textarea) textarea.placeholder = (lang === 'so')
    ? 'Fadlan si kooban u sheeg adeega aad ka faaÊ¼iday, waxa wanaagsanaa iyo talo soo jeedin haddii ay jiraan. (3 xariiqo waa ku filan)'
    : 'Please briefly describe the service you used, what went well and any improvement suggestions. (3 lines recommended)';
  if (openBtn) openBtn.textContent = translations[lang] && translations[lang]['testimonials.leave'] ? translations[lang]['testimonials.leave'] : 'Leave us a message';
  if (sendBtn) sendBtn.textContent = translations[lang] && translations[lang]['form.send'] ? translations[lang]['form.send'] : 'Send Message';

  // no results text
  const noResults = document.getElementById('lawyerNoResults');
  if (noResults) {
    noResults.textContent = translations[lang] && translations[lang]['lawyers.noResults'] ? translations[lang]['lawyers.noResults'] : 'No lawyers match your search.';
  }
}

// Filtering logic
function filterLawyers() {
  const q = (document.getElementById('searchLawyer')?.value || '').trim().toLowerCase();
  const practice = (document.getElementById('practiceFilter')?.value || '').trim().toLowerCase();

  const cards = Array.from(document.querySelectorAll('#lawyerList .card'));
  let visibleCount = 0;
  cards.forEach(card => {
    const name = (card.dataset.name || card.querySelector('.card-title')?.textContent || '').toLowerCase();
    const practiceCard = (card.dataset.practice || '').toLowerCase();
    const text = (card.querySelector('.card-text')?.textContent || '').toLowerCase();

    // match by name or text if query present
    const matchesQuery = q === '' || name.includes(q) || text.includes(q);
    const matchesPractice = practice === '' || practiceCard === practice;

    if (matchesQuery && matchesPractice) {
      card.style.display = ''; // show
      visibleCount++;
    } else {
      card.style.display = 'none'; // hide
    }
  });

  // show/hide "no results" row
  const noResults = document.getElementById('lawyerNoResults');
  if (noResults) noResults.style.display = (visibleCount === 0) ? '' : 'none';
}

// Wire up search + filter events (call once on DOMContentLoaded)
function wireSearchAndFilter() {
  const search = document.getElementById('searchLawyer');
  const pf = document.getElementById('practiceFilter');

  if (search) {
    search.addEventListener('input', () => {
      filterLawyers();
    });
    // allow Enter to focus first matching card (optional)
    search.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        // if first visible card exists, focus its view-profile button
        const first = document.querySelector('#lawyerList .card[style*="display:"]:not([style*="display: none"])') || document.querySelector('#lawyerList .card');
        if (first) {
          const view = first.querySelector('.view-profile') || first.querySelector('.book-now');
          if (view) view.focus();
        }
      }
    });
  }
  if (pf) pf.addEventListener('change', () => {
    filterLawyers();
  });
}

// Call updateSearchAndFormText when language changes.
// If your setTextByI18n(lang) exists, call updateSearchAndFormText(lang) at the end of it.
// Example: add this line inside your setTextByI18n after translations applied:
//    updateSearchAndFormText(lang);

// Also call this on initial load:
document.addEventListener('DOMContentLoaded', () => {
  const currentLang = (window.state && window.state.lang) ? window.state.lang : (localStorage.getItem('lang') || 'en');
  updateSearchAndFormText(currentLang);
  wireSearchAndFilter();
  filterLawyers(); // initial run
});


  // ---------------- init ----------------
  function init(){
    // nav toggle
    $('#navToggle')?.addEventListener('click', ()=> { const nav = $('#mainNav'); nav.style.display = (nav.style.display === 'block') ? '' : 'block'; });

    // theme & lang
    const langSel = $('#langSelect'); const darkBtn = $('#darkToggle');
    if(langSel) { langSel.value = state.lang; langSel.addEventListener('change', e => { state.lang = e.target.value; localStorage.setItem('lang', state.lang); setTextByI18n(state.lang); collectLawyers(); setupTestimonials(); }); }
    applyTheme(state.theme);
    darkBtn?.addEventListener('click', ()=> { state.theme = (state.theme === 'dark') ? 'light' : 'dark'; applyTheme(state.theme); });

    // core setup
    collectLawyers(); setupBookingForm(); setupContactForm(); setupSubscribe();
    setupBackToTop(); setupPartnersCarousel(); setupTestimonials(); setupProfileAndCards(); setupRevealAndCounters(); setupHeaderBehavior();

    // modal close X
    $$('.modal-x').forEach(x => x.addEventListener('click', (e) => { const m = e.target.closest('.modal'); if(m) { m.setAttribute('aria-hidden','true'); document.body.style.overflow=''; } }));

    // hero/book buttons
    $('#heroBookBtn')?.addEventListener('click', ()=> openModal('bookingModal'));
    $('#bookBtn')?.addEventListener('click', ()=> openModal('bookingModal'));

    // fill year
    $('#year') && ($('#year').textContent = new Date().getFullYear());

    // initial translations & partner/testimonial sync
    setTextByI18n(state.lang);
  }

  document.addEventListener('DOMContentLoaded', init);
})();
